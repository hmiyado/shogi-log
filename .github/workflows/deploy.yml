name: Deploy to GitHub Pages

on:
  # Reusable workflow として呼び出し可能
  workflow_call:
    inputs:
      data_repo:
        description: 'Data repository (owner/repo)'
        required: true
        type: string
      data_ref:
        description: 'Data repository ref (branch/tag)'
        required: false
        type: string
        default: 'main'
      app_repo:
        description: 'App repository (owner/repo). If not specified, use the workflow repository'
        required: false
        type: string
        default: ''
      app_ref:
        description: 'App repository ref (branch/tag)'
        required: false
        type: string
        default: 'main'

  # スタンドアロン実行（このリポジトリ自体のデプロイ用）
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.upload.outputs.artifact-id }}
    steps:
      # workflow_call の場合: app と data を別々にチェックアウト
      # standalone の場合: このリポジトリのみチェックアウト
      - name: Checkout app repository
        if: inputs.data_repo != ''
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ inputs.app_repo || github.repository }}
          ref: ${{ inputs.app_ref }}
          path: app

      - name: Checkout data repository
        if: inputs.data_repo != ''
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: ${{ inputs.data_repo }}
          ref: ${{ inputs.data_ref }}
          path: data

      - name: Checkout standalone
        if: inputs.data_repo == ''
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup pnpm
        uses: pnpm/action-setup@fe02b34f77f8bc703788d5817da081398fad5dd2 # v4.0.0
        with:
          version: 10

      - name: Setup Node (with cache for data repo)
        if: inputs.data_repo != ''
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'app/pnpm-lock.yaml'

      - name: Setup Node (with cache for standalone)
        if: inputs.data_repo == ''
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: 22
          cache: 'pnpm'
          cache-dependency-path: 'pnpm-lock.yaml'

      - name: Copy data to app
        if: inputs.data_repo != ''
        run: |
          cp -r data/public app/public

      - name: Install dependencies
        run: |
          if [ -d "app" ]; then
            cd app
            pnpm install
          else
            pnpm install
          fi

      - name: Build
        run: |
          if [ -d "app" ]; then
            cd app
            pnpm build
          else
            pnpm build
          fi

      - name: Upload artifact
        id: upload
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: ${{ inputs.data_repo != '' && 'app/dist' || 'dist' }}
